<!DOCTYPE html>
<html>
<head>
    <title>Analytics Hackaton!</title>
    <link href="public/styles/styles.css" media="all" rel="stylesheet" type="text/css"/>
    <script>
       var dashboard = dashboard || {};
    </script>
</head>
<body>

<div class="navbar">
  <div class="container" id="auth-button"></div>
</div>


<header class="siteheader">
<div class="container">

<section id="view-selector">Tom section #view-selector</section>

<div class="row">
    <div class="col-md-12">
      <h1>Google Analytics Dashboard</h1>
    </div>
</div>

</div>
</header>

<div class="pagewrapper">
<main class="container">
  
  

  <div class="row">
    <div class="col-md-12">
      <section class="panel">
        <h2>Timeline</h2>
        <div id="timeline">#timeline placeholder</div>
      </section>
    </div>
  </div>

  <div class="row">
    <div class="col-md-4">
      <section class="panel">
        <h2>Real time</h2>
      </section>
    </div>
    <div class="col-md-4">
      <section class="panel">
        <h2>Yada yada</h2>
      </section>

    </div>
    <div class="col-md-4">
      <section class="panel">
        <h2>IE</h2>
      </section>

    </div>
  </div>

  
  


</main>
</div>

<!-- Step 2: Load the library. -->

<script type="text/javascript" src="public/js/google-client-id.js"></script>

<script>
    (function(w,d,s,g,js,fjs){
        g=w.gapi||(w.gapi={});g.analytics={q:[],ready:function(cb){this.q.push(cb)}};
        js=d.createElement(s);fjs=d.getElementsByTagName(s)[0];
        js.src='public/js/platform.js';
        fjs.parentNode.insertBefore(js,fjs);js.onload=function(){g.load('analytics')};
    }(window,document,'script'));
</script>

<script src="public/js/Chart.js"></script>
<script src="public/js/moment.js"></script>

<!-- Include the ViewSelector2 component script. -->
<!--<script src="public/js/view-selector2.js"></script>
<script src="public/js/date-range-selector.js"></script>
<script src="public/js/active-users.js"></script>-->

<script>
    gapi.analytics.ready(function() {

        var CLIENT_ID = dashboard.googleClientId;

        gapi.analytics.auth.authorize({
            container: 'auth-button',
            clientid: CLIENT_ID
        });

       // Step 4: Create the view selector.

       var viewSelector = new gapi.analytics.ViewSelector({
           container: 'view-selector'
       });

       // Step 5: Create the timeline chart.

       var timeline = new gapi.analytics.googleCharts.DataChart({
           reportType: 'ga',
           query: {
               'dimensions': 'ga:date',
               'metrics': 'ga:sessions',
               'start-date': '30daysAgo',
               'end-date': 'yesterday'
           },
           chart: {
               type: 'LINE',
               container: 'timeline'
           }
       });

       // Step 6: Hook up the components to work together.

       gapi.analytics.auth.on('success', function(response) {
           viewSelector.execute();
       });

       viewSelector.on('change', function(ids) {
           var now = moment(); // .subtract(3, 'day');

           var newIds = {
               query: {
                   ids: ids
               }
           };

           var thisWeek = query({
               'ids': ids,
               'dimensions': 'ga:date,ga:nthDay',
               'metrics': 'ga:sessions',
               'start-date': moment(now).subtract(1, 'day').day(0).format('YYYY-MM-DD'),
               'end-date': moment(now).format('YYYY-MM-DD')
           });
           timeline.set(newIds).execute();


           Promise.all([thisWeek]).then(function (results) {
               console.log(results)
           });
       });
   });

    /**
     * Create a new ViewSelector instance to be rendered inside of an
     * element with the id "view-selector-container".
     */
    var viewSelector = new gapi.analytics.ViewSelector({
        container: 'view-selector-container'
    });

    // Render the view selector to the page.
    viewSelector.execute();

    /**
     * Extend the Embed APIs `gapi.analytics.report.Data` component to
     * return a promise the is fulfilled with the value returned by the API.
     * @param {Object} params The request parameters.
     * @return {Promise} A promise.
     */
    function query(params) {
        return new Promise(function(resolve, reject) {
            var data = new gapi.analytics.report.Data({query: params});
            data.once('success', function(response) { resolve(response); })
                    .once('error', function(response) { reject(response); })
                    .execute();
        });
    }
</script>
</body>
</html>